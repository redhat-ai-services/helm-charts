{{- if .Values.pipelinesNamespace.create -}}
{{- if .Values.pipelinesNamespace.argocdPipelinesUserJob.create -}}
apiVersion: batch/v1
kind: Job
metadata:
  name: create-pipeline-local-user
  namespace: {{ include "ml-gitops-tenant.gitops-name" . }}
  annotations:
    helm.sh/hook: post-install
    helm.sh/hook-delete-policy: before-hook-creation
spec:
  template:
    spec:
      containers:
      - name: create-pipeline-local-user
        {{- with .Values.pipelinesNamespace.argocdPipelinesUserJob.image }}
        image: "{{ .repository }}:{{ .tag }}"
        {{- end }}
        imagePullPolicy: Always
        env:
          # The CICD namespace where the token needs to be deployed to
          - name: CICD_NAMESPACE
            value: {{ include "ml-gitops-tenant.pipelines-name" . }}
        command:
          - /bin/bash
          - -c
          - |
            export HOME=/home/argocd
            echo "Checking if pipeline account already there..."
            HAS_ACCOUNT=$(kubectl get cm argocd-cm -o jsonpath={.data."accounts\.pipeline"})
            if [ -z "$HAS_ACCOUNT" ];
            then
                # Leave this in for compatibility however in 1.6 we use extraConfigs to handle this
                echo "Pipeline account doesn't exist, adding"
                echo "Getting argocd admin credential..."
                if kubectl get secret argocd-cluster;
                then
                  # Create pipeline user
                  kubectl patch cm argocd-cm --patch '{"data": {"accounts.pipeline": "apiKey"}}'
                else
                  echo "Secret argocd-cluster not available, could not interact with API"
                  exit 1
                fi
            else
                echo "Pipeline account already added, skipping"
            fi

            HAS_SECRET=$(kubectl get secret argocd-env-secret -n $CICD_NAMESPACE --ignore-not-found)
            if [ -z "$HAS_SECRET" ];
            then
              echo "No argo-env-secret present, creating"
              PASSWORD=$(oc get secret argocd-cluster -o jsonpath="{.data.admin\.password}" | base64 -d)
              argocd login --insecure --username admin --password ${PASSWORD} argocd-server
              TOKEN=$(argocd account generate-token --account pipeline)
              if [ "$TOKEN" ];
              then
                kubectl create secret generic argocd-env-secret --from-literal=ARGOCD_AUTH_TOKEN=${TOKEN} -n ${CICD_NAMESPACE}
              else
                echo "Token $TOKEN could not be generated, no secret created"
                exit 1
              fi
            else
              echo "The secret argocd-env-secret already exists, skipping"
            fi
      serviceAccount: argocd-argocd-application-controller
      serviceAccountName: argocd-argocd-application-controller
      dnsPolicy: ClusterFirst
      restartPolicy: OnFailure
      terminationGracePeriodSeconds: 30
{{- end }}
{{- end }}